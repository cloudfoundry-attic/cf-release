#!/var/vcap/packages/ruby/bin/ruby --disable-all
pidfile = "/var/vcap/sys/run/stager/stager.pid"
default_timeout = <%= properties.stager.max_staging_duration %>

if !File.exists?(pidfile)
  Dir.glob("/var/vcap/sys/run/stager/expire_*").each do |f|
    File.delete(f)
  end
  puts 0
  exit 0
end

pid = File.read(pidfile).to_i
expire_file = "/var/vcap/sys/run/stager/expire_#{pid}"

drain_wait_secs = 0
if !File.exists?(expire_file)
  begin
    Process.kill('USR2', pid)
    f = File.open(expire_file, "a")
    drain_wait_secs = -2
  rescue Errno::ESRCH
  end
else
  f = File.open(expire_file, "a")
  ctime = f.ctime
  pid_alive = false
  begin
    Process.kill(0, pid)
    pid_alive = true
  rescue Errno::ESRCH
    pid_alive = false
  end

  if Time.now - ctime > 120 || !pid_alive
    drain_wait_secs = 0
    File.delete(expire_file)
  else
    drain_wait_secs = -1
  end
end
puts drain_wait_secs
