#!/usr/bin/env bash

set -e

SCRIPTS_FOLDER="$(dirname "$0")"

ROOT_DEPOT_PATH="$1"
DEPOT_PATH="consul-certs"
CA_NAME="consul-ca"

function create_ca {
  "${SCRIPTS_FOLDER}"/generate_ca_cert --common-name "consulCA" --depot-path "${ROOT_DEPOT_PATH}/${DEPOT_PATH}" --output-file "$CA_NAME"
}

if [[ "$1" == "--recreate-ca" || -z "$1" || ! -d "$1" ]]; then
  echo -e "\e[1m\e[31m[ERROR] Missing ROOT_DEPOT_PATH parameter.\e[0m"
  exit 1
fi

test -d "${ROOT_DEPOT_PATH}/${DEPOT_PATH}" || mkdir -p "${ROOT_DEPOT_PATH}/${DEPOT_PATH}"

if [[ "$2" == "--recreate-ca" ]] || [[ -d "$ROOT_DEPOT_PATH/$DEPOT_PATH" && ! -f "$ROOT_DEPOT_PATH/$DEPOT_PATH/$CA_NAME.crt" ]]; then
  create_ca
elif [[ -d "$ROOT_DEPOT_PATH/$DEPOT_PATH" && -f "$ROOT_DEPOT_PATH/$DEPOT_PATH/$CA_NAME.crt" ]]; then
  echo -e "\e[1m\e[33m[INFO] Using existing consul CA, recreating only client/server certificates\e[0m"
fi

CC_CN="server.dc1.cf.internal"
# Server certificate to share across the consul cluster
"${SCRIPTS_FOLDER}"/generate_end_entity_certs --common-name "$CC_CN" --ca-name "$CA_NAME" --depot-path "$ROOT_DEPOT_PATH/$DEPOT_PATH" --output-file server

# Agent certificate to distribute to jobs that access consul
"${SCRIPTS_FOLDER}"/generate_end_entity_certs --common-name 'consul agent' --ca-name "$CA_NAME" --depot-path "$ROOT_DEPOT_PATH/$DEPOT_PATH" --output-file agent
